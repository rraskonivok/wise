{% extends "base.tpl" %}
{% load bundler_tags %}

{% block main-navigation %}
<ul class="wat-cf">
  <li class="first"><a href="/">Main Page</a></li>
  <li class=""><a href="/ecosystem">Ecosystem</a></li>
  <li class="active"><a>Worksheet</a></li>
  <li class=""><a href="/share">Share</a></li>
</ul>
{% endblock %}

{# --------------------------
Worksheet specific javascript 
-------------------------- #}
{% block includes %}

 <!-- Using /ws/mathjax/ ( which is just a url rewrite to
 /static/js/mathjax ) avoids Firefox strange same-origin
 policy for otf web fonts -->
<!-- <script type="text/javascript"
    src="/ws/mathjax/MathJax.js"></script>-->

{% load_bundle "worksheet_js" %}
{% load_bundle "worksheet_css" %}

{% endblock %}

{# --------------------------
Worksheet Palettes
-------------------------- #}
{% block sidebar %}

<div id="worksheet_sidebar">

    <div class="buttons">
        <button class='math'>
            <img src="/static/img/icons/sigma.svg"/>
        </button>
        
        <button class='rules'>
            <img src="/static/img/icons/transform.svg"/>
        </button>


        <button class='notebook'>
            <img src="/static/img/icons/notebook.svg"/>
        </button>

        <button class='settings'>
            <img src="/static/img/icons/settings.svg"/>
        </button>

        <button class='keys'>
            <img src="/static/img/icons/keys.png"/>
        </button>

        <button id="log_indicator" class='terminal'>
            <img src="/static/img/icons/terminal.png"/>
        </button>

        <button class='snapshot'>
            <img src="/static/img/icons/snapshot.svg"/>
        </button>
    </div>

    <div id="assum_palette" class="palette hidden"></div>
    <div id="math_palette" class="palette hidden"></div>
    <div id="rules_palette" class="palette hidden"></div>
    <div id="settings_palette" class="palette hidden">
        <form class="form" method="get" action="#">
            <div class="group">
                <label class="label">Radio</label>
                <div>
                <input type="radio" value="1" class="checkbox" id="radio_1" name="radio"> <label class="radio" for="radio_1">Option 1</label>
                </div>
                <div>
                <input type="radio" value="2" class="checkbox" id="radio_2" name="radio"> <label class="radio" for="radio_2">Option 2</label>
                </div>
            </div>
        </form>
    </div>

    <div id="keys_palette" class="palette hidden">
        <h3>Keyboard Shortcuts</h3> 
        <dl class="list">
        </dl>
    </div>

    <div id="terminal_palette" class="palette hidden">
        <h3>Error Log</h3>
        <div class="history"></div>
    </div>

</div>

{% endblock %}

{# --------------------------
Init Function + Global Vars
-------------------------- #}
{% block globals %}
<script>
    // The id of the Worksheet corresponding to its index in the
    // database
    var WORKSHEET_ID = {{ ws_id }};

    // This is passed by Django to help us keep track of the #uid
    // counter
    
    // Count of how many "nodes"/uid tagged elements there are in the
    // DOM
    var NAMESPACE_INDEX = {{ namespace_index }};
    
    // Count of how many cells are in the workspace
    var CELL_INDEX = {{ cell_index }};
    
    // Raw json sent from the server when the page
    // initializes
    var JSON_TREE = $.parseJSON('{{ json_cells|safe }}');
    
    // Lookup table of active equations which maps uid -> internal
    // tree object
    //var NODES = {};

    // Array of cells, index corresponds to order on page. Each
    // element contains another array of equations in that cell.
    var CELLS = [];
</script>

{% endblock %}

{% block inline-script %}
<script>

    //MathJax.Hub.Register.MessageHook("New Math", function (message) {
    //  var script = MathJax.Hub.getJaxFor(message[1]).SourceElement();
    //  console.log(message.join(" ")+": '"+script.text+"'");
    //})

    //Only show the workspace after all math is rendered
    //MathJax.Hub.Register.MessageHook("End Process", function (message) {
    //    $(".lines").show();
    //})

    var cmd_visible = 0;

    $('#cmdline').submit(function() {
        use_infix($("#cmdinput").val());
        $("#cmdinput").blur();
        return false;
    });
    
    function init()
    {
        if(!($.browser.mozilla)) {
            $( "#dialog" ).dialog({
                resizable: false,
                height:300,
                width: 350,
                modal: true,
                position: 'center',
                buttons: {
                    "Proceed Anyways": function() {
                        $( this ).dialog( "close" );
                    },
                    "Go Back": function() {
                        javascript:history.go(-1);
                    }
                }
            });
        }

        init_nodes();
        load_math_palette();
        load_rules_palette();
        Wise.Sidebar = new SidebarView({
            el: $("#worksheet_sidebar")
        });
        Wise.Log = new Logger();

        Wise.Log.view =  new LoggerView({
            el: $('#terminal_palette'),
            model: Wise.Log,
        });

        init_keyboard_shortcuts();

        setInterval( "heartbeat()", 10000 );
    
        //Make buttons pretty
        $('.equation button','#workspace').parent().buttonset();
        $('button','#workspace').parent().buttonset();
    
        //Make equations sortable within each cell.
        $(".cell table").sortable({
            handle: '.hand',
        });

        $('.lines').disableSelection();
    
        //$('.editable').editable({loadurl: '#', loadtype: 'POST'})

    }
</script>
{% endblock %}



{# --------------------------
Equations
-------------------------- #}

{% block main %}


<div id="dialog" style="display: none;">
    It appears that you aren't using Firefox 3+. If the
    mathematics displayed on the right does not match the image
    on the left then your browser does not support enough MathML to
    use the worksheet.

    <table style="width: 100%; text-align: center;">
        <tr>
        <td>
            <img src="/static/img/mathml_test.png"/>
        </td>
        <td>
        <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
          <mrow>
            <msup>
              <mi>x</mi>
              <mn>2</mn>
            </msup>
            <msup>
              <mi>y</mi>
              <mn>2</mn>
            </msup>
          </mrow>
        </math>
        </td>
        </tr>
    </table>

    <p>
    <input type="checkbox"/> Don't show me this message again.
    </p>
</div>

<div id="selectionlist">
</div>

<div class="cmd" style="display: none">
    <form id="cmdline" action="#">
        <input id="cmdinput" type="text"></input>
    </form>
</div>

<div id="workspace">
    {% for cell in cells %}
        {{cell|safe}} 
    {% endfor %}
</div>

{% endblock %}
