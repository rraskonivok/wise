{% extends "base.tpl" %}

{# --------------------------
Worksheet specific javascript 
-------------------------- #}
{% block includes %}
  <!-- Load MathJax -->
 <script type="text/javascript" src="/static/mathjax/MathJax.js"></script>

  <!-- Worksheet functionality -->
 <script src="/static/js/worksheet.js" type="text/javascript"></script>

  <!-- Worksheet UI functionality -->
 <script src="/static/js/worksheet_ui.js" type="text/javascript"></script>

  <!-- Worksheet Views -->
 <script src="/static/js/worksheet_views.js" type="text/javascript"></script>

  <!-- Expression tree functionality -->
 <script src="/static/js/tree.js" type="text/javascript"></script>

  <!-- Keyboard shortcuts functionality -->
 <script src="/static/js/keyshortcuts.js" type="text/javascript"></script>

  <!-- Keyboard shortcuts functionality -->
 <script src="/static/js/qtip.js" type="text/javascript"></script>
{% endblock %}

{# --------------------------
Worksheet Palettes
-------------------------- #}
{% block sidebar %}
<div class="block">

  <div class="secondary-navigation">
    <ul class="wat-cf">
      <li id="tab_math_palette" class="active first"><a href="javascript:palette(1)">Palette</a></li>
      <li id="tab_rules_palette"><a href="javascript:palette(2)">Rules</a></li>
    </ul>
  </div>

  <div id="math_palette" style="display:none" class="palette"> </div>

  <div id="rules_palette" style="display:none" class="palette"> </div>

</div>
{% endblock %}

{# --------------------------
Init Function + Global Vars
-------------------------- #}
{% block inline-script %}
<script>
    // This is passed by Django to help us keep track of the #uid
    // counter
    
    // Count of how many "nodes"/uid tagged elements there are in the
    // DOM
    var NAMESPACE_INDEX = {{ namespace_index }};
    
    // Count of how many cells are in the workspace
    var CELL_INDEX = {{ cell_index }};
    
    // Raw json sent from the server when the page
    // initializes
    var JSON_TREE = $.parseJSON('{{ json_cells|safe }}');
    
    // Lookup table of active equations which maps uid -> internal
    // tree object
    //var NODES = {};

    // Array of cells, index corresponds to order on page. Each
    // element contains another array of equations in that cell.
    var CELLS = [];

    // Dictionary of equations indexed by uid
    var EQUATIONS = {};

    //MathJax.Hub.Register.MessageHook("New Math", function (message) {
    //  var script = MathJax.Hub.getJaxFor(message[1]).SourceElement();
    //  console.log(message.join(" ")+": '"+script.text+"'");
    //})

    //Only show the workspace after all math is rendered
    MathJax.Hub.Register.MessageHook("End Process", function (message) {
        $(".lines").fadeIn('fast');
    })

    var cmd_visible = 0;

    $('#cmdline').submit(function() {
        use_infix($("#cmdinput").val());
        $("#cmdinput").blur();
        return false;
    });
    
    function init()
    {
        init_nodes();
        load_math_palette();
        load_rules_palette();

        init_keyboard_shortcuts();

        setInterval( "heartbeat()", 10000 );
    
        //Make buttons pretty
        $('.equation button','#workspace').parent().buttonset();
        $('button','#workspace').parent().buttonset();
    
        //Make equations sortable within each cell.
        //$(".lines tbody").sortable({
        //    //handle: '.hand',
        //}).disableSelection();
    
        bind_hover_toggle();

    }
</script>
{% endblock %}



{# --------------------------
Equations
-------------------------- #}

{% block main %}
<div id="selectionlist">
</div>

<div class="cmd" style="display: none">
    <form id="cmdline" action="#">
        <input id="cmdinput" type="text">
    </form>
</div>

<div class="block" id="block-text">
  <div class="secondary-navigation">
    <ul class="wat-cf">
      <li class="active first"><a href="#block-text">Worksheet</a></li>
      <li><a href="javascript:new_cell()">New Cell</a></li>
      <li><a href="javascript:new_line('eq')">New Equation</a></li>
      <li><a href="javascript:new_line('def')">New Definition</a></li>
      <li><a href="javascript:new_line('func')">New Function</a></li>
    </ul>
  </div>
  <div class="content">

    <div id="cell_selection" class="pagination"></div>
    <h2 class="title">{{title|title}}</h2>
    <div class="inner">
      <hr />
      <p> 
      <!--<span class="gray"><a href="javascript:$('.equation
              button').toggle()">Toggle Controls</a> | <a
              id="hovertoggle" href="#">Show
              Containers</a></span> -->
      </p>
        <div id="workspace">
            {% for equation in equations %}
                {{equation|safe}} 
            {% endfor %}
        </div>
        <!-- State indicators -->
        <img id="quasimode-indicator" style="float: right; opacity: 0.1"
        src="/static/img/icons/bullet_red.png" 
        title="You are in BASE mode, clicking will not have any side-effects."/>

        <img id="basemode-indicator" style="float: right" src="/static/img/icons/bullet_green.png" 
        title="You are in ACTION mode, clicking may have side-effects."/>
    </div>
  </div>
</div>
{% endblock %}
