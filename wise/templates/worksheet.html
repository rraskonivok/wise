<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Wise ( {{title|title}} ) </title>

  <link rel="stylesheet" type="text/css" href="/static/css/math.css" />
  <link rel="stylesheet" type="text/css" href="/static/ui/ui.css" />
  <link rel="stylesheet" href="/static/css/base.css" type="text/css" media="screen" />
  <link rel="stylesheet" id="current-theme" href="/static/css/themes/default/style.css" type="text/css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/static/css/worksheet.css" />

  <!-- Load jQuery -->
 <script src="/static/jquery.js" type="text/javascript"></script>
 <script src="/static/jquery-ui.js" type="text/javascript"></script>
 <script src="/static/dimensions.js" type="text/javascript"></script>
 <script src="/static/tooltip.js" type="text/javascript"></script>


  <!-- ajaxmanager.js -->
 <script src="/static/jquery.ajaxmanager.js"></script> 

  <!-- underscore.js -->
 <script src="/static/underscore.js" type="text/javascript"></script>

  <!-- underscore.js -->
 <script src="/static/js/json2.js" type="text/javascript"></script>

  <!-- backbone.js / depends on underscore.js and json2.js -->
 <script src="/static/js/backbone.js" type="text/javascript"></script>

  <!-- Notification Plugin -->
 <script src="/static/pnotify.js" type="text/javascript"></script>

 <!-- Hotkeys Plugin -->
 <script src="/static/keys.js" type="text/javascript"></script>

</head>
<body>
  <div id="container">
    <div id="header">
      <h1><a href="/">Wise</a></h1>
      <div id="user-navigation">
        <ul class="wat-cf">
          <li><a href="#">{{username}}</a></li>
          <li><a href="#">Profile</a></li>
          <li><a href="#">Settings</a></li>
          <li><a class="logout" href="/accounts/logout">Logout</a></li>
        </ul>
      </div>

      <div id="main-navigation">
        <ul class="wat-cf">
          <li class="first"><a href="/">Main Page</a></li>
          <li class="active"><a href="#block-text">Worksheet</a></li>
        </ul>
      </div>
    </div>
    <div id="wrapper" class="wat-cf">
      <div id="main">

        <div class="block" id="block-text">
          <div class="secondary-navigation">
            <ul class="wat-cf">
              <li class="active first"><a href="#block-text">Worksheet</a></li>
              <li><a href="javascript:new_line('eq')">New Cell</a></li>
              <li><a href="javascript:new_line('def')">New Definition</a></li>
            </ul>
          </div>
          <div class="content">
            <h2 class="title">{{title|title}}</h2>
            <div class="inner">
              <hr />
              <p> <span class="gray"><a href="javascript:$('.equation button').toggle()">Toggle Controls</a> | <a id="hovertoggle" href="#">Show Containers</a></span></p>
              <p class="first">
                <div id="workspace">
                    {% for equation in equations %}
                        {{equation|safe}} 
                    {% endfor %}
                </div>
              </p>
            </div>
          </div>
        </div>

        <div id="selectionlist">
        </div>

        <div class="cmd" style="display: none">
            <form id="cmdline" action="#">
                <input id="cmdinput" type="text">
            </form>
        </div>

      </div>
      <div id="sidebar">
        <div class="block">

          <div class="secondary-navigation">
            <ul class="wat-cf">
              <li id="tab_math_palette" class="active first"><a href="javascript:palette(1)">Palette</a></li>
              <li id="tab_rules_palette"><a href="javascript:palette(2)">Rules</a></li>
            </ul>
          </div>

          <div id="math_palette" style="display:none" class="palette">
          </div>

          <div id="rules_palette" style="display:none" class="palette">
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Load jsMath -->
 <script type="text/javascript" src="/static/mathjax/MathJax.js"></script>

  <!-- Worksheet functionality -->
 <script src="/static/js/worksheet.js" type="text/javascript"></script>

  <!-- Expression tree functionality -->
 <script src="/static/js/tree.js" type="text/javascript"></script>

 <!-- Script is put down here to optimize load time -->
 <script type="text/javascript">

    // This is passed by Django to help us keep track of the #uid
    // counter
    
    // Count of how many "nodes"/uid tagged elements there are in the
    // DOM
    var NAMESPACE_INDEX = {{ namespace_index }};
    
    // Count of how many cells are in the workspace
    var CELL_INDEX = {{ cell_index }};
    
    // Raw json sent from the server when the page
    // initializes
    var JSON_TREE = $.parseJSON('{{ json_cells|safe }}');
    
    
    // Lookup table of active equations which maps uid -> internal
    // tree object
    var NODES = {};

    var a = $.manageAjax.create('queue', {queue: true});
    // InfoVis Canvas object and active_graph singleton
    var __CANVAS__;
    var active_graph = null;
    
    $(document).ajaxError(function() {
        error("Error connecting to server");
    });
    
    $(document).ready(function () {
        init();
    });

    $(document).ajaxStart(function () {
        $('#ajax_loading').show();
    })
    $(document).ajaxStop(function () {
        $('#ajax_loading').hide();
    })

    $('#cmdline').submit(function() {
        use_infix($("#cmdinput").val());
        $("#cmdinput").blur();
        return false;
    });

    //MathJax.Hub.Register.MessageHook("New Math", function (message) {
    //  var script = MathJax.Hub.getJaxFor(message[1]).SourceElement();
    //  console.log(message.join(" ")+": '"+script.text+"'");
    //})

    //Only show the workspace after all math is rendered
    MathJax.Hub.Register.MessageHook("End Process", function (message) {
        $(".lines").fadeIn('fast');
    })
    
    $(document).ajaxSuccess(function() {
        $('.expand').click(function() {
            $(this).next().toggle();
            return false;
        }).next()
    });

    function palette(num) {
        if(num == 1) {
            $('#math_palette').show();
            $('#rules_palette').hide();
            $('#tab_math_palette').addClass('active');
            $('#tab_rules_palette').removeClass('active');
        }
        else {
            $('#math_palette').hide();
            $('#rules_palette').show();
            $('#tab_rules_palette').addClass('active');
            $('#tab_math_palette').removeClass('active');
        }
    }

    var cmd_visible = 0;

    function show_cmdline() {
       $('.cmd').fadeIn();
       $('#cmdinput').focus();
       cmd_visible = 1;
    }

    function hide_cmdline() {
       $('.cmd').fadeOut();
       $('#cmdinput').focus();
       cmd_visible = 0;
    }
    
    function toggle_cmdline() {
        //Flip visibility bit

        if(cmd_visible) {
            hide_cmdline();
        } else {
            show_cmdline();                 
        }
        
        cmd_visible = cmd_visible ^ 1;
    }
    
    function init()
    {
        $(document).bind( 'keydown', 'f4', function() {show_debug_menu()})
            .bind('keydown', 'del', function() {remove_element()})
            .bind('keydown', 'd', function() {remove_element()})
            .bind('keydown', 'esc', function() {clear_selection()})
            .bind('keydown', 'r', function() {refresh_jsmath()})
            .bind('keydown', 'w', function() {next_placeholder()})
            .bind('keydown', 'o', function() {new_line('eq')})
            .bind('keydown', 's', function() {apply_rule('algebra_normal',null)})
            // Variable substitutions 
            .bind('keydown', 'x', function() {use_infix('x')})
            .bind('keydown', 'y', function() {use_infix('y')})
            .bind('keydown', 'z', function() {use_infix('z')})
            .bind('keydown', 't', function() {use_infix('t')})
            // Operation substitutions
            .bind('keydown', '+', function() {use_infix('ph+ph')})
            .bind('keydown', '/', function() {use_infix('ph/ph')})
            .bind('keydown', '*', function() {use_infix('ph*ph')})
            .bind('keydown', '-', function() {use_infix('ph-ph')})
            .bind('keydown', '^', function() {use_infix('ph^ph')})
            // Number substitutions
            .bind('keydown', '2', function() {use_infix('2')})
            .bind('keydown', '1', function() {use_infix('1')})
            .bind('keydown', '0', function() {use_infix('0')})
            .bind('keydown', 'ctrl+space', function() {toggle_cmdline()}
        )
        
        $.ajax({
                url: '/rule_request',
                success: function(data) {
                    $("#rules_palette").replace(data);
                    $(".panel_category","#rules_palette").bind('click',function() {
                            $(this).next().toggle();
                            // Only typeset when needed
                            MathJax.Hub.Typeset($(this).next()[0]);
                            return false
                    }).next().hide();

                }
        });

        //Load the math palette
        $.ajax({
            url: '/palette/',
            success: function(data) {
                $("#math_palette").replace(data)
        
        
                //Make the palette sections collapsable
                $(".panel_category","#math_palette").bind('click',function() {
                        $(this).next().toggle();
                        // Only typeset when needed
                        MathJax.Hub.Typeset($(this).next()[0]);
                        return false
                }).next().hide();
        
                //Make the math terms interactive
                traverse_lines();
                resize_parentheses()
            }
        });
    
        //Make buttons pretty
        $('.equation button','#workspace').parent().buttonset();
        $('#cmdbuttons button').parent().buttonset();
    
        //Make equations sortable within each cell.
        $(".lines tbody").sortable({
            //handle: '.hand',
        }).disableSelection();
    
    
        for(var cell in JSON_TREE) {
            cell_index = cell;
            var cell = JSON_TREE[cell];
            var new_cell = new Cell();
            new_cell.dom = $('#workspace').find('[data-index='+cell_index+']');
            for(var eq in cell){
                var eq_index = eq;
                var eq = cell[eq];
                EQUATIONS[eq_index] = build_tree_from_json(eq);
                new_cell.equations.add(eq);
            }
            CELLS.push(new_cell);
        }
        
        bind_hover_toggle();
    }

 </script>

</body>
</html>

